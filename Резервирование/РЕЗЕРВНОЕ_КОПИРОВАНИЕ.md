__Термины резервного копирования__   
- RTO (Recovery Time Objective) - определяет время, требуемое на восстановление из резервной копии. Это не то, что диктуется процессом РК, что=то требование, которому процесс должен соответствовать. Например, “восстановление из РК должно занимать
не более 1 часа”.
- RPO (Recovery Point Objective) - точка во времени (Point in Time), на которую должны быть восстановлены данные. Например, “Данные должны быть восстановлены по состоянии не “дальше”, чем 24 часа с момента сбоя”.
- Уровень резервного копирования (Backup Level) - 0-1-2, Full, Differential, Incremental. Различные стратегии выбора данных для копирования.
- Глубина резервного копирования - определяет как долго хранятся резервные копии.
- Стратегия хранения - определяет “детализацию”, с которой можно восстановиться.

__Уровни резервного копирования__     
- Full - полное резервное копирование. Для восстановлениā требуется только эта резервная копия.
- Differential - разностное резервное копирование. Копируется только то, что изменилось с последнего резервного копирования. Для восстановления требуется последняя полная и последняя дифференциальная копии.
- Incremental - инкрементальное резервное копирование. Копируется только то, что изменилось с последнего прохода резервного копирования. Для восстановления требуется: последняя полная; последняя дифференциальная (если есть); ВСЕ инкрементальные копии с момента последней полной/дифференциальной копии.


__Требования к системе РК__  
- Автоматизация
- Хранение на отдельном носителе или в другом месте
- Надежность места хранения
- Доступность места хранения
- Простота использования


__Вопросы для планирования РК__    
- Репликация/Дублирование
- От каких сбоев мы хотим защититься? (Зачем?)
- Что надо копировать?
- Как быстро надо восстанавливать? (RTO)
- На сколько “близко” точка восстановления? (RPO)
- Где все это хранить?
- Сколько это стоит?


__Правило 3-2-1 для бекапов__     
- Имейте не менее трех копий данных
- Храните копии как минимум на двух физических носителях разного типа
- Одну копию храните удаленно, вне офиса


__Сопутствующие действия__    
- Проверка целостности копий/проверка хранилища
- Мониторинг:
   - Хранилища
   - Агентов
   - ПО
   - Процесса
- Проверка восстанавливаемости    

## Создание бекапов с помощью утилит
### Ручное копирование
Основные проблемы:
- Создание упорядоченного архива (решается `date+format`)
- Удаленное хранение (решается с помощью SSH, NFS)


Инструменты:
- tar
- rsync
- dump
- dd
- rsync + inotify = lsyncd
- https://clonezilla.org/
- https://serveradmin.ru/kvm-backup/


__Утилиты копирования__      
С помощью утилиты tar (архивирование)
```
tar -czvf nginx_conf.tar.gz /etc/nginx
```
С помощью утилиты dd (побайтовое копирование)
```
dd if=/dev/sdb of=/mnt/backup/sdb.img
```
С помощью утилиты rsync
```
rsync -av --delete /etc/ /mnt/backup/hostname/etc
rsync -az -e ssh --delete user@192.168.2.1:/etc/nginx/ /etc/nginx
```

__Rsnapshot__    
- Perl-скрипт бÿкапа
- Поддержка расписаний
- Автоматическая ротация
- Запуск по крону
- Поддержка бекап-скриптов (для БД и т.д.)
- Поддержка LVM-снепшотов
- Использование жестких ссылок
- Инкрементальные бекапы (для файлов)
- apt install rsnapshot
- Конфиг: /etc/rsnapshot.conf

### BorgBackup    
https://borgbackup.readthedocs.io/en/stable/     


BorgBackup (или просто Borg) — это мощная и надёжная open-source утилита для резервного копирования с дедупликацией, ориентированная на производительность, безопасность и экономию места. Она особенно популярна среди Linux-администраторов, потому что отлично справляется с бэкапом серверов и рабочих станций.    

__Основные возможности BorgBackup:__     
- Дедупликация: исключение дублирующих копий повторяющихся данных. Файлы в рамках одного Borg repository (т.е. специальном каталоге в специфичном для Borg формате) делатся на блоки по N мегабайт, а повторяющиеся блоки Borg дедуплицирует.
- Сжатие: после дедупликации данные сжимаются.
- Работает через SSH: отсюда простота и безопасность. На обеих сторонах только и нужно, что поставить Borg
- Прост в установке: PPA, Epel-Release, бинарники
- Гибкая очистка от старых бекапов

__Borg (установка на сервере)__     
Из репозитория
```
apt install borgbackup
```
Можно также просто скачать бинарник
```
wget https://github.com/borgbackup/borg/releases/download/1.2.7/borg-linux64 -O /usr/local/bin/borg
chmod +x /usr/local/bin/borg
```
Создание пользователя borg (на клиенте предварительно нужно сгенерировать SSH-ключи)
```
useradd -m borg
su - borg
cd ~; mkdir .ssh
vim .ssh/authorized_keys
command="/usr/bin/borg serve" ssh-rsa ...
chmod 700 ~/.ssh
chmod 600 ~/.ssh/authorized_keys
```

__Borg (установка на клиенте)__     
Из репозитория
```
apt install borgbackup
```
Можно также просто скачать бинарник
```
wget https://github.com/borgbackup/borg/releases/download/1.2.7/borg-linux64 -O /usr/local/bin/borg
chmod +x /usr/local/bin/borg
```
Генерация ключей
```
ssh-keygen
```
https://docs.vultr.com/automatic-backups-with-borgbackup-on-ubuntu-20-04-97025     

__Borg (создание бэкапа)__    
На клиенте:    
Инициализация репозитория
```
borg init -e none borg@172.17.0.3:MyBorgRepo
```
Создание РК
```
borg create --stats --list borg@172.17.0.3:MyBorgRepo::"MyFirstBackup-{now:%Y-%m-%d_%H:%M:%S}" /etc /root
```
На сервере:    
Просмотр репозитория
```
borg list MyBorgRepo/
```
Просмотр бэкапа    
```
borg list MyBorgRepo::MyFirstBackup-2018-08-04_16:55:53
```
Извлечение из бэкапа
```
borg extract MyBorgRepo::MyFirstBackup-2018-08-04_16:55:53 etc/hostname
```
