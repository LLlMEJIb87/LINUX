# Auditd

<p align="center">
<image src="https://github.com/LLlMEJIb87/LINUX/blob/main/%D0%9B%D0%BE%D0%B3%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5/Picture/audit_d.PNG">
</p>

__auditd__ - подсистема аудита в ядре Linux, отслеживает критичные с точки зрения безопасности системные события    

В подсистему аудита входят демон auditd и несколько вспомогательных утилит:
- auditctl — утилита для управления демоном auditd; позволяет получать информацию о текущем состоянии подсистемы аудита, а также добавлять и удалять правила;
- autrace — утилита для аудита событий, порождаемых процессами (работает по тому же принципу, что и strace);
- ausearch — утилита для поиска событий в журнальных файлах;
- aureport — утилита для генерации отчётов о работе системы аудита.    


__auditd:__
- Пишет логи аудита
- Для удобства просмотра логов можно использовать ausearch и aureport
- Команда auditctl позволяет настраивать правила аудита вручную
- После загрузки системы правила читаются из /etc/audit/audit.rules
- Некоторые параметры auditd можно изменить в /etc/audit/auditd.conf


__Конфигурирование auditd__    
Настройки подсистемы аудита хранятся в конфигурационном файле /etc/audit/auditd.conf. Он содержит в числе прочих следующие параметры:
- log_file — файл, в котором будут храниться логи подсистемы аудита;
- log_format — формат, в котором будет сохранены логи;
- freq — максимальное число записей протокола, которые могут храниться в буфере;
- flush — режим синхронизации буфера с диском (none — ничего не делать, incremental — переносить данные из буфера на диск с частотой, указанной в значении параметра freq; data — синхронизировать немедленно, sync —
синхронизировать как данные, так и метаданные файла при записи на диск);
- max_log_file — максимальный размер файла лога в мегабайтах;
- max_log_file_action — действие при превышении максимального размера файла лога;
- space_left — минимум свободного пространства в мегабайтах, по достижении которого должно быть осуществлено действие, указанное в следующем параметре;
- space_left_admin — указывает, что делать, когда на диске недостаточно свободного места (ignore — ничего не делать; syslog — отправлять в syslog, email — отправлять уведомление по почте;
- suspend — прекратить запись логов на диск;
- single — перейти в однопользовательский режим; halt — выключить машину)
- disk_full_action — действие, которое нужно осуществить при переполнении диска (этот параметр может принимать те же значения, что и space_left_admin)


__Создание правил auditd__     
```
auditctl -a <список>, <действие> -S <имя системного вызова> -F <фильтры>
```  
После опции -а указывается список, в который нужно добавить правило. Всего существует 5 таких списков:
- task — события, связанные с созданием новых процессов;
- entry — события, которые имеют место при входе в системный вызов;
- __exit — события, которые имеют место при выходе из системного вызова;__
- user — события, использующие параметры пользовательского пространства;
- exclude — используется для исключения событий.

Затем указывается, что нужно делать после наступления события. Здесь возможны два варианта: always (события будут записываться в журнал) и never (не будут).    
После опции -S идёт имя системного вызова, при котором событие нужно перехватить (open, close и т.п.).     
После опции -F указываются дополнительные параметры фильтрации.     
Если нам требуется вести аудит обращений к файлам из каталога /etc, правило будет выглядеть так:
```
sudo auditctl -a exit,always -S open -F path=/etc
```

Рассмотрим пример типового файла правил:
```
# отслеживать системные вызовы unlink () и rmdir()
-a exit,always -S unlink -S rmdir
# отслеживать системные вызовы open () от пользователя с UID 1001
-a exit,always -S open -F loginuid=1001
# отслеживать доступ к файлам паролей и групп и попытки их изменения:
-w /etc/group -p wa
-w /etc/passwd -p wa
-w /etc/shadow -p wa
-w /etc/sudoers -p wa
# отслеживать доступ к следующей директории:
-w /etc/my_directory -p r
```
