# Память
## Виртуальная память
Программе при старте выдается блок виртуальной памяти со своим личным адресным пространством (столько сколько запросит программа), запись в физическую память происходит только тогда когда программа действительно начинает писать данные.     


Виртуальной памяти может выделяться больше (over commit memory), чем физической, так как выделение вирт.памяти процессу не значит, что он будет использовать всю выделенную память.     


За счёт виртуальной памяти мы можем делать переадресацию не только в RAM но и на другие устройтсва - так работает файл подкачки SWAP   


Ядро OS ведет memory map - соответсвие виртуальной памяти физической     

<p align="center">
<image src="https://github.com/LLlMEJIb87/LINUX/blob/main/%D0%9F%D0%B0%D0%BC%D1%8F%D1%82%D1%8C/Picture/virt_pamyat.PNG">
</p>

### Практика
1. простая команда, которая покажет сколько памяти доступно в системе, сколько занято и свободно. Утилита берет информацию из файла  cat /proc/__meminfo__
```
shmel@lvm:~$ free -h
               total        used        free      shared  buff/cache   available
Mem:           1.9Gi       557Mi       258Mi       1.2Mi       1.3Gi       1.4Gi
Swap:          2.0Gi        12Ki       2.0Gi
```
- **Total** - памяти всего доступно в системе
- **Used** - сколько памяти используется на данный моменто
- **Free** - показывает сколько памяти в данный момент не нужно системе ( в случае если значение половина или более от total, то памяти в сервере избыточно)
- **shared** используется для межпроцессового взаимодействия
- **buf/cashe** - прослойка где формируются правильные размеры кусков данных ( к примеру когда приходят данные из сети на диск) + кеш
- **available** - сколько памяти будет доступно в случае необходимости (примерная велечина)   free + ~70 процентов от кеша  

#### Cache
__cache__ - область памяти выделенная для того, чтобы наши программы работали с данными с диска, файлы подгружаются в кеш из кеша предоставляется доступ программе для этих данных. Файл, который попал в кеш будет храниться там покак система себе это может позволить. Логика простая - как можно меньше обращаться к диску. Поэтому система занимает достаточно много памяти в процессе работы, в случае если памяти будет не хватать, то система высвободин данные из кеша (скинет на диск)    

- Существует команда в Linux, которая позволяет сбросить (высвободить) данные из кеша, которые в данный момент не нужны работающим программам
```
echo 3 > /proc/sys/vm/drop_caches
```
- Когда система понимает, что пора высвобождать кеш из памяти? - это можно посмотреть
```
root@lvm:~# cat /proc/sys/vm/min_free_kbytes 
45056
```
- Грязные страницы – это страницы оперативной памяти (RAM), которые были изменены, но ещё не записаны на диск. Есть нюанс, если процент гряхных страниц выходит за допустимы предел, то процесс останавливается и срабатывает служба принудительно сброса на диск. Кретичный момент для базы данных. Посмотреть кол-во памяти, которое занимаю грязные страницы можно:
```
cat /proc/meminfo | grep Dirty
```
Синхронизировать в ручную
```
sync
```
Посомтреть настройки,  сколько процентов об общей памяти может быть отдано под кеш грязных страниц
```
root@lvm:~# cat /proc/sys/vm/dirty_ratio 
20
root@lvm:~# cat /proc/sys/vm/dirty_background_ratio 
10
```

Существую 3 типа кеша:
1. vfs
- кеш файловой системы, данные которые содержут информацию об inode и директориях
2. Анонимный
- у него нет страниц, которые соответсвуют данным на диске,память которая хранит данные, которые возникли в процессе работы программы
3. Файловый
- Когда программа хочет получить доступ к файлу, файл подгружается в файловый кеш. Страницы на диске и странице в памяти соответсвуют друг другу.

#### Swap
Файл подкачки, это то место на диске куда система в случае необходимости может выгружать ананимный кеш - только его, все остальное не требует swap оно и так имеет соответсвие на диске     

swap можно использовать как индикатор, если на него сбрасываются данные, что-то не так с поведением системы либо обределенной программы (утечка памяти)
