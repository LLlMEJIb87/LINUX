# Дисковая подсистема: RAID
**RAID** (Redundant Array of Independent Disks) — это технология объединения нескольких физических жёстких дисков в один логический массив для улучшения производительности, надёжности или обоих параметров одновременно. Суть RAID заключается в распределении данных между дисками с использованием различных методов, в зависимости от выбранного уровня RAID.

## RAID 0
Объединяет 2 диска в единое логическое пространство и общий объем логического пространсва равен сумме дисков. RAID массив объединяет диски только равного объема ( либо будет зафиксирован объем минимального диска)   
Плюсы:
-  файл размазывается по двум дискам и считывание происходит быстрее (в случае если приложение поддерживает многопоточный режим)

Минусы:
- самый ненадежный массив, так как файлы разманы по двум дискамм и в случае выходного одного вся информация теряется

## RAID 1
Самый надежный raid массив (данные записываются на два диска - зеркалирование), но самый экономически не выгодный. Объем массива равен объему одного диска

## RAID 5
RAID 5 — это один из самых популярных уровней RAID, который предлагает хороший баланс между производительностью, надёжностью и экономией места на дисках. Он использует паритет для обеспечения избыточности данных, что позволяет восстанавливать данные в случае сбоя одного из дисков.   

Важно понимать, что если диски покупались одного производителя и одной серии, то в случае выхода из строя одного начинается ребилд и нагружаются остальные диски, которые так же могут выйти из строя. В случае сбоя одного диска данные можно восстановить, но процесс восстановления может занять много времени и нагрузить остальные диски. Если во время восстановления произойдёт сбой второго диска, все данные будут потеряны.   

Не рекомендуется хранить важные данные на этом уровне.

## RAID 10
RAID 10 (или RAID 1+0) — это комбинация двух других уровней RAID: RAID 1 (зеркалирование) и RAID 0 (стрипинг). RAID 10 сочетает в себе преимущества обоих этих уровней, обеспечивая как высокую производительность, так и хорошую надёжность. Это один из самых популярных уровней RAID для критически важных и высоконагруженных систем.    
RAID 10: выбирается для высокопроизводительных систем, где необходимо обеспечить и высокую скорость, и надежность. Часто используется в системах с высокими нагрузками, например, для работы с базами данных.

## RAID 6
RAID 6 — это уровень RAID, который предлагает высокую избыточность и защиту данных. Он похож на RAID 5, но с дополнительной защитой: вместо одного блока паритета, RAID 6 использует два блока паритета, что позволяет пережить выход из строя двух дисков одновременно.    
RAID 6: используется, когда требуется высокая избыточность и защита от потери данных при выходе из строя двух дисков.

### Работа с RAID
Находясь в операционной системе мы можем узнать настроен ли програмный raid массив используя команду lsblk, в выводе мы увидим блочное устройтсво с наименованием md0 . Узнать об аппаратном raid можно по косвенным признакам:
- Можно проверить логи системы, например, с помощью команды dmesg, чтобы увидеть сообщения о подключении устройств. При старте системы аппаратный RAID-контроллер может выводить информацию о своих массивах
```
dmesg | grep -i raid
```
- Информация о железе
```
lspci | grep -i raid
```
**Настройка RAID в уже установленной  OS**
1. lsblk покажет нам список блочных устройств
2. Cоздаем массив
```
sudo mdadm --create --verbose /dev/md0 --level=1 --raid-devices=2 /dev/sdb /dev/sdc
```
3. Проверить что сейчас в системе есть в рамках RAID массива можно:
```
cat /proc/mdstat
```
вывод
```
md0 : active raid1 sdc[1] sdb[0]
      10476544 blocks super 1.2 [2/2] [UU]
```
4. По сути у нас создалось новое блочное устройство
```
sudo fdisk -l /dev/md0
```
вывод
```
Disk /dev/md0: 9.99 GiB, 10727981056 bytes, 20953088 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
```
5. Для возможности работы создаем на массиве md0 файловую систему
```
 mkfs.ext4 /dev/md0
```
6. Делаем монтировани - соответсвтие блочного устройства с файловой системой какого то конкретного каталога
```
mount /dev/md0 /test_raid/
```
7. Проверяем, что монтирование произошло успешно
```
df -hT
```
вывод
```
/dev/md0       ext4    9.8G   24K  9.3G   1% /test_raid
```
8. Чтобы RAID автоматически монтировался при загрузке системы по лейблу, делаем следующее
8.1 Задаем лейбл нашему RAID1
```
e2label /dev/md0 TEST_RAID
```
проверяем, что лейбл успешно назначен
```
blkid /dev/md0 
/dev/md0: LABEL="TEST_RAID1" UUID="dc837d8f-7aef-4ee5-bf5f-8fe4267fabbb" BLOCK_SIZE="4096" TYPE="ext4"
```
8.2 Добавляем запись в /etc/fstab
```
LABEL=TEST_RAID1 /test_raid/ ext4 defaults 0 2
```
Проверяем  нет ли ошибок
```
mount -a
```
8.3 Посмотреть детальную информацию об RAID массиве

### Восстановление массива после сбоя
1. В целях обучения "сломаем" raid массив 
```
mdadm --manage /dev/md0 --fail /dev/sdc
```
вывод mdadm -D /dev/md0, покажет статус degraded
```
State : clean, degraded
 Number   Major   Minor   RaidDevice State
       0       8       16        0      active sync   /dev/sdb
       -       0        0        1      removed

       1       8       32        -      faulty   /dev/sdc
```
2. удаляем устройство из RAID массива
```
mdadm --manage /dev/md0 --remove /dev/sdc
```
3. Добавляем исправный диск
```
mdadm --manage /dev/md127 --add /dev/sdd
```
4. Если хотим использовать диск который стоял в райде для другого массива или не использовать более в массиве то удаляем метаданные raid
```
sudo mdadm --zero-superblock /dev/sdc
```
